<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-US">
<head>
    <title>Vulnerability Observer</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'PsirtPageAnalyzer/css/jquery.mobile-1.4.5.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'PsirtPageAnalyzer/css/style.css' %}"/>
    <script src="{% static 'PsirtPageAnalyzer/js/jquery.min.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/jquery.mobile-1.4.5.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/Chart.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/underscore-min.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/app.js' %}"></script>
</head>

<body style="margin: 0">
<div id="page-head">Vulnerability Observer</div>
<div id="summary-area">
    <div id="canvas-holder">
        <div><h3>Severity Ratio</h3></div>
        <canvas id="pie-chart-area" width="300" height="300"/>
    </div>
    <div id="canvas-holder2">
        <div><h3>Monthly Increasing Trend</h3></div>
        <canvas id="line-chart-area" width="400" height="300"/>
    </div>

    <div id="canvas-holder3">
        <div><h3>Monthly Update Trend</h3></div>
        <canvas id="bar-chart-area" width="400" height="300"/>
    </div>
    <div id="chartjs-tooltip"></div>
</div>
<div id="detail-area">
    <a href="#popupBUSelection" data-rel="popup" data-position-to="sildeup"
       class="ui-btn ui-corner-all ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a"
       data-transition="pop" id="buselection-btn">Catalog</a>

    <div data-role="popup" id="popupBUSelection" data-theme="none" class="ui-corner-all">
        <fieldset data-role="controlgroup" style="margin: 0px;">
            {% for bu in bsus %}
                <input type="radio" name="radionname" id="{{ bu.radioname }}" value="{{ bu.key }}">
                <label for="{{ bu.radioname }}">{{ bu.name }}</label>
            {% endfor %}
        </fieldset>
    </div>

    <div class="ui-field-contain inline-search-block">
        <input type="search" name="searching" data-corners="false" id="search-all" value="">
    </div>
    <div class="ui-input-btn ui-btn ui-corner-all inline-display">
        Search
        <input type="button" data-enhanced="true" value="Search">
    </div>
</div>
<div id="search-result-area">
    <div id="searched-product-name"></div>
    <div id="search-result" style="text-align: center"></div>
</div>
<a href="#show-vuls-dialog" data-rel="popup" style="display: none" id="popup-for-vul-link"></a>

<div data-role="popup" id="show-vuls-dialog" class="ui-content" data-theme="a"
     style="padding: 0px; width: 900px; font-size: 14px; font-family: NotoSans;">
</div>
<script>

    Chart.defaults.global.customTooltips = function (tooltip) {
        // Tooltip Element
        var tooltipEl = $('#chartjs-tooltip');
        // Hide if no tooltip
        if (!tooltip) {
            tooltipEl.css({
                opacity: 0
            });
            return;
        }

        // Set caret Position
        tooltipEl.removeClass('above below');
        tooltipEl.addClass(tooltip.yAlign);
        // Set Text
        tooltipEl.html(tooltip.text);
        // Find Y Location on page
        var top;
        if (tooltip.yAlign == 'above') {
            top = tooltip.y - tooltip.caretHeight - tooltip.caretPadding;
        } else {
            top = tooltip.y + tooltip.caretHeight + tooltip.caretPadding;
        }
        // Display, position, and set styles for font
        tooltipEl.css({
            opacity: 1,
            left: tooltip.chart.canvas.offsetLeft + tooltip.x + 'px',
            top: tooltip.chart.canvas.offsetTop + top + 'px',
            fontFamily: tooltip.fontFamily,
            fontSize: tooltip.fontSize,
            fontStyle: tooltip.fontStyle
        });
    };

    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/\{(\d+)\}/g,
                function (m, i) {
                    return args[i];
                });
    };


    function buildTableHead(columnsMap) {
        var head = "";
        $.each(columnsMap, function (key, val) {
            var keys = key.split("|");
            if (val.length == 1) {
                head += "<th {0}>{1}</th>".format(val[0], keys[0].charAt(0).toUpperCase() + keys[0].substring(1));
            } else if (val.length == 3) {
                head += "<th {0}>{1}</th>".format(val[0], val[2]);
            } else {}
        });
        return head;
    }

    function buildTableBody(vuls, columnsMap) {
        var trs = "";
        _.each(vuls, function (v, index) {
            var vul = (typeof v === "string") ? JSON.parse(v) : v;
            var tds = "";
            $.each(columnsMap, function (key, val) {
                var subKeys = key.split("|");
                if (val.length > 1) {
                    if (subKeys.length == 2) {
                        tds += "<td>{0}</td>".format(val[1].format(vul[subKeys[1]], vul[subKeys[0]]));
                    } else {
                        var content = "";
                        if (vul[key] instanceof Array) {
                            _.each(vul[key], function(v) {
                               content += v + "<br>";
                            });
                        } else {
                            content = val[1].format(vul[key]);
                        }

                        tds += "<td>{0}</td>".format(content);
                    }
                }
            });

            trs += "<tr><th>{0}</th>{1}</tr>".format(index + 1, tds);
        });
        return trs;
    }

    $(document).ready(function () {
        Psirt.init(document, window);
        Psirt.loadVulsData();
        Psirt.loadBUsData();

        var searchfunc = function () {
            var searchCondition = $("#search-all").val().split(':');
            var result = Psirt.search(searchCondition[0], searchCondition[1]);
            if (result.error != undefined) {
                $("searched-product-name").html("");
                $("#search-result").html("<h3 style='color:red'>" + result.error + "</h3>");
            } else {
                $("#searched-product-name").html("<H3>Product: " + result.product.name + "</H3>");

                // render search result table
                var searchTblTmpl = '<table data-role="table" id="search-result-table" data-mode="columntoggle" ' +
                        'class="ui-body-d ui-shadow table-stripe ui-responsive" data-column-btn-theme="b" ' +
                        'data-column-btn-text="Columns to display..." data-column-popup-theme="a">{0}</table>';
                var searchTblHeadTmpl = '<thead><tr class="ui-bar-d">{0}</tr></thread>';
                var searchTblBodyTmpl = '<tbody>{0}</tbody>';

                var columnsMap =
                {
                    "index": ['data-priority="1"'],
                    "lenovoCode|link": ['data-priority="2"', '<a href="{0}" target="_blank">{1}</a>', 'Lenovo Security Advisory'],
                    "severity": ['data-priority="3"', '{0}', 'Severity'],
                    "description": ['', '{0}', 'Description'],
                    "downloadLink": ['data-priority="5"', '<a href="{0}" target="_blank">link</a>', 'Download'],
                    "fixedVersion": ['data-priority="6"', '{0}', 'Fixed Version'],
                    "updateDate": ['data-priority="7"', '{0}', 'Update Date']
                };

                // build head
                var head = buildTableHead(columnsMap);
                // build body
                var trs = buildTableBody(result.vuls, columnsMap);
                var tblHtml = searchTblTmpl.format(searchTblHeadTmpl.format(head) + searchTblBodyTmpl.format(trs));

                $("#search-result").empty();
                $("#search-result").append(tblHtml);
                $("#search-result-table").table();
            }
        };

        var renderVulsTblfunc = function (vuls) {
            var vulTblTmpl = '<table data-role="table" id="vuls-table" ' +
                        'class="ui-body-d ui-shadow table-stripe ui-responsive" data-column-btn-theme="b">{0}</table>';
            var vulTblHeadTmpl = '<thead><tr>{0}</tr></thread>';
            var vulTblBodyTmpl = '<tbody>{0}</tbody>';

            var columnsMap =
            {
                "index": ['data-priority="1"'],
                "lenovoCode|link": ['data-priority="2"', '<a href="{0}" target="_blank">{1}</a>', 'Lenovo Security Advisory'],
                "description": ['', '{0}', 'Description'],
                "firstPublishedDate": ['data-priority="6"', '{0}', 'Published Date'],
                "lastUpdatedDate": ['data-priority="7"', '{0}', 'Update Date']
            };

            // build head
            var head = buildTableHead(columnsMap);
            // build body
            var trs = buildTableBody(vuls, columnsMap);
            var tblHtml = vulTblTmpl.format(vulTblHeadTmpl.format(head) + vulTblBodyTmpl.format(trs));
            $("#show-vuls-dialog").empty();
            $("#show-vuls-dialog").append(tblHtml);
            $("#vuls-table").table();
        };

        // bind brand selection click event
        $("label[for^='radionname-']").each(function (i, el) {
            $(el).bind('mouseup', function () {
                $("#searched-product-name").html('');
                $("#search-all").val(this.textContent + ":");
            });
        });


        // bind search result click
        $("input[value='Search']").click(searchfunc);
        $("#search-all").keypress(function (e) {
            if (e.which == 13) {
                e.preventDefault();
                searchfunc();
            }
        });

        // chart event
        $("#pie-chart-area").click(function (event) {
            var activePoints = Psirt.charts[0].getSegmentsAtEvent(event);
            var severity = activePoints[0].label;

            $("#popup-for-vul-link").trigger("click", [severity]);
        });

        $("#popup-for-vul-link").click(function(event, severity) {
            var vuls = Psirt.getVulsBySeverity(severity);
            renderVulsTblfunc(vuls);
        });

    });
</script>
</body>

</html>
