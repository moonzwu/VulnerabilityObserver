<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-US">
<head>
    <title>Vulnerability Observer</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'PsirtPageAnalyzer/css/jquery.mobile-1.4.5.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'PsirtPageAnalyzer/css/style.css' %}"/>
    <script src="{% static 'PsirtPageAnalyzer/js/jquery.min.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/jquery.mobile-1.4.5.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/Chart.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/underscore-min.js' %}"></script>
    <script src="{% static 'PsirtPageAnalyzer/js/app.js' %}"></script>
</head>

<body style="margin: 0">
<div id="summary-area">
    <div id="canvas-holder">
        <canvas id="pie-chart-area" width="300" height="300"/>
    </div>
    <div id="canvas-holder2">
        <canvas id="line-chart-area" width="400" height="300"/>
    </div>

    <div id="canvas-holder3">
        <canvas id="bar-chart-area" width="400" height="300"/>
    </div>
    <div id="chartjs-tooltip"></div>
</div>
<div id="detail-area">
    <a href="#popupBUSelection" data-rel="popup" data-position-to="sildeup"
       class="ui-btn ui-corner-all ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a"
       data-transition="pop" id="buselection-btn">Brand</a>

    <div data-role="popup" id="popupBUSelection" data-theme="none" class="ui-corner-all">
        <fieldset data-role="controlgroup" style="margin: 0px;">
            {% for bu in bsus %}
                <input type="radio" name="radionname" id="{{ bu.radioname }}" value="{{ bu.key }}">
                <label for="{{ bu.radioname }}">{{ bu.name }}</label>
            {% endfor %}
        </fieldset>
    </div>

    <div class="ui-field-contain inline-search-block">
        <input type="search" name="searching" id="search-all" value="">
    </div>
    <div class="ui-input-btn ui-btn ui-corner-all inline-display">
        Search
        <input type="button" data-enhanced="true" value="Search">
    </div>
</div>
<div id="search-result-area">
    <div id="searched-product-name"></div>
    <div id="search-result-tbl">
    </div>
</div>

<script>

    Chart.defaults.global.customTooltips = function (tooltip) {
        // Tooltip Element
        var tooltipEl = $('#chartjs-tooltip');
        // Hide if no tooltip
        if (!tooltip) {
            tooltipEl.css({
                opacity: 0
            });
            return;
        }

        // Set caret Position
        tooltipEl.removeClass('above below');
        tooltipEl.addClass(tooltip.yAlign);
        // Set Text
        tooltipEl.html(tooltip.text);
        // Find Y Location on page
        var top;
        if (tooltip.yAlign == 'above') {
            top = tooltip.y - tooltip.caretHeight - tooltip.caretPadding;
        } else {
            top = tooltip.y + tooltip.caretHeight + tooltip.caretPadding;
        }
        // Display, position, and set styles for font
        tooltipEl.css({
            opacity: 1,
            left: tooltip.chart.canvas.offsetLeft + tooltip.x + 'px',
            top: tooltip.chart.canvas.offsetTop + top + 'px',
            fontFamily: tooltip.fontFamily,
            fontSize: tooltip.fontSize,
            fontStyle: tooltip.fontStyle
        });
    };

    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/\{(\d+)\}/g,
                function (m, i) {
                    return args[i];
                });
    };


    $(document).ready(function () {
        Psirt.init(document, window);
        Psirt.loadVulsData();
        Psirt.loadBUsData();

        // bind brand selection click event
        $("label[for^='radionname-']").each(function (i, el) {
            $(el).bind('mouseup', function () {
                $("#search-all").attr("value", this.textContent + ":");
            });
        });

        // bind search result click
        $("input[value='Search']").click(function () {
            var searchCondition = $("#search-all").val().split(':');
            var result = Psirt.search(searchCondition[0], searchCondition[1]);
            if (result.error != undefined) {
                alert(result.error);
            } else {
                $("#searched-product-name").html("<H3>" + result.product.name + "</H3>");

                // render search result table
                var result_tbl = '<table data-role="table" id="table-custom-2" data-mode="columntoggle" ' +
                        'class="ui-body-d ui-shadow table-stripe ui-responsive" data-column-btn-theme="b" ' +
                        'data-column-btn-text="Columns to display..." data-column-popup-theme="a">{0}</table>';
                var result_tbl_thead = '<thead><tr class="ui-bar-d">{0}</tr></thread>';
                var result_tbl_body = '<tbody>{0}</tbody>';

                var columnsMap =
                {
                    "lenovoCode|link": '<a href="{0}">{1}</a>',
                    "severity": '{0}',
                    "description": '{0}',
                    "status": '{0}',
                    "downloadLink": '<a href="{0}">link</a>',
                    "fixedVersion": '{0}'
                };

                // build head
                var head = "";
                $.each(columnsMap, function (key, val) {
                    var keys = key.split("|");
                    head += "<th>{0}</th>".format(key[0]);
                });


                // build body
                var trs = "";
                _.each(result.vuls, function (vulStr, index) {
                    var vul = JSON.parse(vulStr);
                    var tds = "";
                    $.each(columnsMap, function (key, val) {
                        var keys = val.split("|");
                        if (keys.length == 2) {
                            tds += "<td>{0}</td>".format(val.format(vul[keys[0]], vul[keys[1]]));
                        } else {
                            tds += "<td>{0}</td>".format(val.format(vul[key]));
                        }
                    });

                    trs += "<tr><th>{0}</th>{1}</tr>".format(index, tds);
                });
                result_tbl.format(result_tbl_thead.format(head) + result_tbl_body.format(trs));
                $("#search-result-tbl").empty();
                $("#search-result-tbl").append(result_tbl);

            }
        });

    });
</script>
</body>

</html>
