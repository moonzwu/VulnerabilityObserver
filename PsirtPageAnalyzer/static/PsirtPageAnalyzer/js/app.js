/**
 * Created by Administrator on 7/21/2015.
 */
(
    function () {
        "use strict";

        var root = this;

        var Psirt = function (document, window) {
            var psirt = this;
            this.document = document;
            this.window = window;

            this.monthLables = ["January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "Augest",
                "September",
                "October",
                "November",
                "December"];
            this.vulnerabilities = [];
            this.trendData = {};

            Chart.defaults.global.customTooltips = function (tooltip) {
                // Tooltip Element
                var tooltipEl = $('#chartjs-tooltip');
                // Hide if no tooltip
                if (!tooltip) {
                    tooltipEl.css({
                        opacity: 0
                    });
                    return;
                }

                // Set caret Position
                tooltipEl.removeClass('above below');
                tooltipEl.addClass(tooltip.yAlign);
                // Set Text
                tooltipEl.html(tooltip.text);
                // Find Y Location on page
                var top;
                if (tooltip.yAlign == 'above') {
                    top = tooltip.y - tooltip.caretHeight - tooltip.caretPadding;
                } else {
                    top = tooltip.y + tooltip.caretHeight + tooltip.caretPadding;
                }
                // Display, position, and set styles for font
                tooltipEl.css({
                    opacity: 1,
                    left: tooltip.chart.canvas.offsetLeft + tooltip.x + 'px',
                    top: tooltip.chart.canvas.offsetTop + top + 'px',
                    fontFamily: tooltip.fontFamily,
                    fontSize: tooltip.fontSize,
                    fontStyle: tooltip.fontStyle
                });
            };
        };

        // -- draw the chart to the page
        var drawerHelpers = Psirt.drawerHelpers = {};

        var drawPieChart = drawerHelpers.drawPieChart = function (highCount, mediumCount, lowCount, self) {
                var pieData = [{
                    value: highCount,
                    color: "#F7464A",
                    highlight: "#FF5A5E",
                    label: "High"
                }, {
                    value: mediumCount,
                    color: "#FDB45C",
                    highlight: "#FFC870",
                    label: "Medium"
                }, {
                    value: lowCount,
                    color: "#46BFBD",
                    highlight: "#5AD3D1",
                    label: "Low"
                }];

                var pieCtx = self.document.getElementById("pie-chart-area").getContext("2d");
                self.window.myPie = new Chart(pieCtx).Pie(pieData);
            },
            drawLineChart = drawerHelpers.drawLineChart = function (data, self) {
                var d = new Date();
                var data = {
                    labels: gMonthsLabels,
                    datasets: [{
                        label: d.getFullYear(),
                        fillColor: "rgba(220,220,220,0.2)",
                        strokeColor: "rgba(220,220,220,1)",
                        pointColor: "rgba(220,220,220,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(220,220,220,1)",
                        data: data
                    }]
                };
                var lineCtx = self.document.getElementById("line-chart-area").getContext("2d");
                self.window.myLine = new Chart(lineCtx).Line(data);
            };

        //-- load data from server
        var dataHelpers = Psirt.dataHelpers = {};

        var loadVulsData = dataHelpers.loadVulsData = function () {
            var self = Psrit;

            $.getJSON("api/vuls", function (vuls) {
                var highCount = 0;
                var mediumCount = 0;
                var lowCount = 0;

                $.each(vuls, function (index) {
                    var obj = JSON.parse(vuls[index]);
                    gVuls.push(obj);

                    if (obj.severity == 1)
                        highCount++;
                    else if (obj.severity == 2)
                        mediumCount++;
                    else
                        lowCount++;
                    var fstPublished = new Date(obj.firstPublishedDate)

                });

                drawerHelpers.drawPieChart(highCount, mediumCount, lowCount, self);
                //drawLineChart(data, self);
            });
        };


        var amd = (typeof define == 'function' && define.amd);
        if (amd) {
            define(function () {
                return Psirt;
            });
        } else if (typeof module === 'object' && module.exports) {
            module.exports = Psirt;
        }
    }
).call(this);
