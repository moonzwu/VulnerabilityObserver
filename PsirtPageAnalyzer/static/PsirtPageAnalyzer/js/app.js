var Psirt = (function () {
    var Vulnerabilities = [];
    var BusinessUnits = [];
    var productCache = {};
    var charts = [];
    var MonthLabels = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "Augest",
        "September",
        "October",
        "November",
        "December"
    ];
    var SeverityMap = {
        "High" : 1,
        "Medium" : 2,
        "Low" : 3
    };


    var init = function (document, window) {
        this.document = document;
        this.window = window;


    };

    var drawPieChart = function (severityData) {
        var pieData = [{
            value: severityData[0],
            color: "#F7464A",
            highlight: "#FF5A5E",
            label: "High"
        }, {
            value: severityData[1],
            color: "#FDB45C",
            highlight: "#FFC870",
            label: "Medium"
        }, {
            value: severityData[2],
            color: "#46BFBD",
            highlight: "#5AD3D1",
            label: "Low"
        }];

        var pieCtx = document.getElementById("pie-chart-area").getContext("2d");
        charts.push(new Chart(pieCtx).Pie(pieData));
    };

    var drawLineChart = function (yearLabel, trendData) {
        var data = {
            labels: MonthLabels,
            datasets: [{
                label: yearLabel,
                fillColor: "rgba(151,187,205,0.2)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(151,187,205,1)",
                data: trendData
            }]
        };
        var lineCtx = document.getElementById("line-chart-area").getContext("2d");
        charts.push(new Chart(lineCtx).Line(data, {bezierCurve: false}));
    };

    var drawBarChart = function (yearLabel, trendData) {
        var data = {
            labels: MonthLabels,
            datasets: [
                {
                    label: yearLabel,
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(151,187,205,0.8)",
                    highlightFill: "rgba(151,187,205,0.75)",
                    highlightStroke: "rgba(151,187,205,1)",
                    data: trendData
                }
            ]
        };

        var barCtx = document.getElementById("bar-chart-area").getContext("2d");
        charts.push(new Chart(barCtx).Bar(data));
    };


    var updateTrend = function (theDate, trendData) {
        var fstPublished = new Date(theDate);
        var fullYear = fstPublished.getFullYear();
        var month = fstPublished.getMonth();
        if (trendData[fullYear] == undefined) {
            trendData[fullYear] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        }
        trendData[fullYear][month]++;
    };


    var loadVulsData = function () {
        $.getJSON("api/vuls", function (vuls) {
            var severityData = [0, 0, 0];
            var incTrendData = {};
            var updTrendData = {};
            var thisYear = (new Date()).getFullYear();

            $.each(vuls, function (index) {
                var obj = JSON.parse(vuls[index]);
                obj.cveCodes = JSON.parse(obj.cveCodes.replace(/'/g, "\""));
                Vulnerabilities.push(obj);
                severityData[obj.severity - 1]++;

                // get the trend of each month
                updateTrend(obj.firstPublishedDate, incTrendData);
                updateTrend(obj.lastUpdatedDate, updTrendData);

            });

            drawPieChart(severityData);
            drawLineChart(thisYear, _.reject(incTrendData[thisYear], function (num) {
                return num == 0;
            }));
            drawBarChart(thisYear, _.reject(updTrendData[thisYear], function (num) {
                return num == 0;
            }));
        });
    };

    var loadBUsData = function () {
        $.getJSON("api/bsus", function (bsus) {
            _.each(bsus, function (bu) {
                BusinessUnits.push(bu);
            });
        });
    };

    var getVulsBySeverity = function(severity) {
        return _.reject(Vulnerabilities, function(vul){
            return SeverityMap[severity] != vul.severity;
        });
    };

    var searchInCache = function(inputProductName) {
        var result = _.find(productCache, function(p) {
            var d = JSON.parse(p);
            return d.key.indexOf(inputProductName) > -1;
        });
        return result;
    };

    var search = function(inputBuName, inputProductName) {

        // check BU name
        var foundBU = _.find(BusinessUnits, function(bu){
            return bu.name == inputBuName;
        });

        if (foundBU == undefined) {
            return {"error": "No this kind of catalog '" + inputBuName + "'."};
        }

        if (inputProductName == '') {
            return {"error": "Please input one product at least."};
        }

        // find product
        var foundProduct = searchInCache(inputProductName);
        $.ajaxSettings.async = false;
        if (foundProduct == undefined) {
            $.getJSON("api/bsus/" + foundBU.key + "/products", function (buProducts) {
                var foundOne = _.find(buProducts.prodList, function (str) {
                    var product = JSON.parse(str);
                    return product.name.indexOf(inputProductName) > -1;
                });

                if (foundOne != undefined) {
                    productCache[foundOne.name] = foundOne;
                    foundProduct = JSON.parse(foundOne);
                }
            });
        }

        if (foundProduct == undefined) {
            $.ajaxSettings.async = true;
            return {"error" : "No this kind of product '" + inputProductName + "' in '" + inputBuName + "' catalog."};
        }

        // find vulnerabilities
        var foundVuls = [];
        $.getJSON("api/product/"+foundProduct.key+"/vuls", function (prodVuls) {
            if (prodVuls.vulList.length != 0) {
                foundVuls =  prodVuls.vulList;
            }
        });
        $.ajaxSettings.async = true;

        return {
            "product": foundProduct,
            "vuls": foundVuls
        };
    };

    return {
        businessUnits: BusinessUnits,
        vulnerabilities: Vulnerabilities,
        charts: charts,
        init: init,
        loadVulsData: loadVulsData,
        loadBUsData: loadBUsData,
        search:search,
        getVulsBySeverity: getVulsBySeverity
    };
})();
