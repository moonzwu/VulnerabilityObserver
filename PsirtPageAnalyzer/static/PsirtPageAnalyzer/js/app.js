var Psirt = (function () {
    var Vulnerabilities = [];
    var BusinessUnits = [];
    var MonthLabels = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "Augest",
        "September",
        "October",
        "November",
        "December"
    ];

    var init = function (document, window) {
        this.document = document;
        this.window = window;


    };

    var drawPieChart = function (severityData) {
        var pieData = [{
            value: severityData[0],
            color: "#F7464A",
            highlight: "#FF5A5E",
            label: "High"
        }, {
            value: severityData[1],
            color: "#FDB45C",
            highlight: "#FFC870",
            label: "Medium"
        }, {
            value: severityData[2],
            color: "#46BFBD",
            highlight: "#5AD3D1",
            label: "Low"
        }];

        var pieCtx = document.getElementById("pie-chart-area").getContext("2d");
        window.myPie = new Chart(pieCtx).Pie(pieData);
    };

    var drawLineChart = function (yearLabel, trendData) {
        var data = {
            labels: MonthLabels,
            datasets: [{
                label: yearLabel,
                fillColor: "rgba(151,187,205,0.2)",
                strokeColor: "rgba(151,187,205,1)",
                pointColor: "rgba(151,187,205,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(151,187,205,1)",
                data: trendData
            }]
        };
        var lineCtx = document.getElementById("line-chart-area").getContext("2d");
        window.myLine = new Chart(lineCtx).Line(data, {bezierCurve: false});
    };

    var drawBarChart = function (yearLabel, trendData) {
        var data = {
            labels: MonthLabels,
            datasets: [
                {
                    label: yearLabel,
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(151,187,205,0.8)",
                    highlightFill: "rgba(151,187,205,0.75)",
                    highlightStroke: "rgba(151,187,205,1)",
                    data: trendData
                }
            ]
        };

        var barCtx = document.getElementById("bar-chart-area").getContext("2d");
        window.myBar = new Chart(barCtx).Bar(data);
    };

    var fillBUsOption = function () {
        var alphaTable = "abcdefghijklmnopqrstuvwxyz";
        var brandsHtml = '<fieldset data-role="controlgroup">{0}</fieldset>';
        var itemTemp = '<input type="radio" name="{0}" id="{1}"> <label for="{1}">{2}</label>';

        var innerHtml = "";
        var placeHolder = "fakename-";

        _.each(BusinessUnits, function (bu, index) {
            innerHtml += itemTemp.format(placeHolder, placeHolder + alphaTable.charAt(index), bu.name);
        });

        if ($("#brand-list-area").html().trim() == "")
            $("#brand-list-area").append(brandsHtml.format(innerHtml));
    };

    var updateTrend = function (theDate, trendData) {
        var fstPublished = new Date(theDate);
        var fullYear = fstPublished.getFullYear();
        var month = fstPublished.getMonth();
        if (trendData[fullYear] == undefined) {
            trendData[fullYear] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        }
        trendData[fullYear][month]++;
    };


    var loadVulsData = function () {
        $.getJSON("api/vuls", function (vuls) {
            var severityData = [0, 0, 0];
            var incTrendData = {};
            var updTrendData = {};
            var thisYear = (new Date()).getFullYear();

            $.each(vuls, function (index) {
                var obj = JSON.parse(vuls[index]);
                Vulnerabilities.push(obj);
                severityData[obj.severity - 1]++;

                // get the trend of each month
                updateTrend(obj.firstPublishedDate, incTrendData);
                updateTrend(obj.lastUpdatedDate, updTrendData);

            });

            drawPieChart(severityData);
            drawLineChart(thisYear, _.reject(incTrendData[thisYear], function (num) {
                return num == 0;
            }));
            drawBarChart(thisYear, _.reject(updTrendData[thisYear], function (num) {
                return num == 0;
            }))
        });
    };

    var loadBUsData = function () {
        $.getJSON("api/bsus", function (bsus) {
            _.each(bsus, function (bu) {
                BusinessUnits.push(bu);
            });

            fillBUsOption();
        });


    };

    return {
        businessUnits: BusinessUnits,
        vulnerabilities: Vulnerabilities,
        init: init,
        loadVulsData: loadVulsData,
        loadBUsData: loadBUsData
    };
})();
